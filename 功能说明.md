# 杰理AC63系列蓝牙SDK功能说明文档

## 项目概述

这是一个基于杰理科技（Jieli）AC63系列蓝牙芯片的通用SDK固件程序，用于开发蓝牙应用。项目整合了Zephyr RTOS等开源组件，支持多种蓝牙协议和应用场景。

## 主要功能模块

### 1. 蓝牙功能模块

#### SPP_LE (蓝牙数据透传)
- 支持蓝牙串口透传(Serial Port Profile)
- 支持低功耗蓝牙(LE)
- 适用于数据传输、中心设备、广播设备、信标(Beacon)、多连接、Dongle等场景

#### HID (人机接口设备)
- 支持键盘、鼠标、遥控器、游戏手柄等人机接口设备
- 支持语音遥控器功能

#### Mesh (蓝牙网格网络)
- 支持物联网节点自组网
- 支持天猫精灵接入
- 支持自组网应用

### 2. 音频功能模块

#### 音频解码/编码
- 支持音频解码功能(audio_decode)
- 支持音频编码功能(audio_encode)
- 包含数字音量控制(audio_digital_vol)
- 噪声门限控制(audio_noise_gate)
- 丢包补偿(audio_plc)

#### 音频工具
- 音频工具集(audio_utils)
- 正弦波生成(sine_make)

### 3. 设备管理模块

#### 输入设备
- 触摸按键(touch_pad)
- 光学鼠标传感器(optical_mouse_sensor)
- 按键(key)
- AD按键(ad_key)
- 红外遥控(ir_key)

#### 存储设备
- SPI Flash/NOR Flash存储(norflash)

#### 传感器
- 入耳检测(in_ear_detect)

### 4. 通信接口模块

#### UART串口通信
- 支持UART通信协议

#### 2.4G RF通信
- 支持RF24G通信(rf24g)
- 支持RF433通信(rf433)

#### USB通信
- 支持USB设备通信

### 5. 系统功能模块

#### 电源管理
- 电池电量检测
- 低电压检测(LVD)
- 自动关机功能
- 充电管理(charge)

#### 定时器管理
- 多种定时器功能(mcpwm, plcnt, pwm_led)
- 手动握手定时器(handshake_timer)

#### 更新与升级
- 支持OTA空中升级(update)
- 支持串口升级(uart_update)
- 支持测试盒升级(testbox_update)
- 支持双备份升级机制

#### 外部MCU通信
- 支持外部MCU串口通信(ex_mcu_uart)

### 6. 用户应用模块

#### LED控制
- LED灯带控制(led_strip)
- WS2812灯带效果库(ws2812-fx-lib)

#### 协议处理
- 支持协议解析(protocol)

#### 一线通功能
- 支持一线通(one_wire)

### 7. AI与语音功能

#### 关键词识别
- 支持关键词识别(JL KWS)
- 集成语音算法(jl_kws_algo)
- 支持语音事件处理(jl_kws_event)

### 8. 数据处理模块

#### JSON解析
- 支持JSON数据解析(cJSON)

#### 代码转换
- 支持代码切换功能(code_switch)

### 9. 硬件抽象层

#### ADC接口
- ADC API接口(adc_api)

#### IIC接口
- 硬件IIC(iic_hw)
- 软件IIC(iic_soft)

#### SPI接口
- SPI通信接口(spi)

#### 省电管理
- 功耗管理(power_manage)

### 10. 蓝牙协议栈

#### 经典蓝牙
- 支持蓝牙5.0/5.1协议栈
- 支持A2DP音频流传输
- 支持AVCTP控制协议

#### 低功耗蓝牙
- 支持BLE协议栈
- 支持HOGP(HID over GATT Profile)
- 支持GATT服务定义

## 主要函数功能说明

### 1. 应用主入口函数
- [app_main()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/apps/spp_and_le/app_main.c#L170-L278): 应用程序主入口函数，负责初始化各个模块并启动主任务
- [app_switch()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/apps/spp_and_le/app_main.c#L285-L305): 应用模式切换函数，用于在不同应用间切换
- [my_main()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/apps/spp_and_le/app_main.c#L511-L545): 主要的初始化函数，初始化LED、ADC、定时器等外设

### 2. 系统功能函数
- [main_while()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/apps/spp_and_le/app_main.c#L460-L483): 主循环函数，每10ms调用一次，处理RF24G按键、灯光效果、声音处理等
- [sound_handle()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/apps/spp_and_le/app_main.c#L386-L456): 声音处理函数，实现声控功能和音乐触发
- [user_timer_init()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/apps/spp_and_le/app_main.c#L339-L367): 用户定时器初始化函数
- [user_timer_isr()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/apps/spp_and_le/app_main.c#L319-L336): 用户定时器中断服务函数

### 3. 电源管理函数
- [check_power_on_key()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/apps/spp_and_le/app_main.c#L144-L167): 检查开机按键，实现按键开机功能
- [app_var_init()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/apps/spp_and_le/app_main.c#L129-L136): 应用变量初始化函数

### 4. 蓝牙功能函数
- [start_app()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/include_lib/system/app_core.h#L63-L64): 启动指定的应用
- [get_current_app()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/include_lib/system/app_core.h#L65-L66): 获取当前运行的应用

### 5. 音频处理函数
- [audio_dec_init()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/apps/spp_and_le/app_main.c#L214-L217): 音频解码初始化
- [audio_enc_init()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/apps/spp_and_le/app_main.c#L214-L217): 音频编码初始化

### 6. 语音识别函数
- [jl_kws_main_user_demo()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/apps/common/jl_kws/jl_kws_main.c#L26-L30): 关键词识别主函数演示

### 7. 系统配置函数
- [request_irq()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/include_lib/driver/cpu/irq.h#L45-L46): 请求中断服务函数
- [os_time_dly()](file:///D:/A_WorkSt/Aworkst/2026-01-16-%E6%A3%AE%E6%9C%A8/code/project-2026-01-16-6329C-SOP16/include_lib/system/os/os_api.h#L143-L144): 操作系统延时函数

## 技术规格

- 蓝牙协议版本：支持蓝牙5.0和5.1
- 支持经典蓝牙和低功耗蓝牙
- 支持USB烧录和OTA空中升级
- 支持单备份和双备份升级机制
- 支持Code::Blocks和Makefile构建系统

## 应用领域

- 蓝牙透传、数据传输
- 遥控器、键盘、鼠标等HID设备
- 物联网节点、自组网应用
- 语音遥控器
- 游戏手柄
- 智能家居控制

# 杰理AC63系列蓝牙SDK程序流程说明

## 程序启动流程

1. 系统初始化
   - 加载系统配置文件
   - 初始化系统服务
   - 初始化电源管理模块

2. 更新检查
   - 检查是否有待处理的更新
   - 如果有更新则处理更新结果

3. 电源检查
   - 检查充电状态
   - 根据充电状态决定是否需要进行电压检测

4. 开机按键检测
   - 如果配置了需要按键开机，则检测开机按键
   - 若未检测到有效按键操作则自动软关机

5. 音频模块初始化
   - 初始化音频解码模块
   - 初始化音频编码模块

6. 语音识别初始化
   - 如果启用关键词识别功能，初始化语音识别模块

## 主程序流程

### app_main()函数执行流程

1. 检查更新状态
   ```
   if (!UPDATE_SUPPORT_DEV_IS_NULL()) {
       update = update_result_deal();
   }
   ```

2. 电源管理处理
   - 检查充电状态
   - 执行电压检测或充电检测

3. 按键检测（如果需要按键开机）
   - 循环检测按键状态
   - 达到设定时间后确认开机
   - 否则进入软关机状态

4. 模块初始化
   - 音频模块初始化
   - 语音识别模块初始化（如果启用）

5. 应用程序启动
   - 根据配置宏选择不同的应用模式
   - 设置意图(Intent)参数
   - 启动相应的应用程序

### 主要应用模式

根据不同配置宏(CONFIG_APP_*)，程序可运行以下模式：

- **SPP_LE模式**: 蓝牙数据透传应用
- **AT_COM模式**: AT指令通信应用
- **DONGLE模式**: 蓝牙适配器应用
- **MULTI模式**: 多连接应用
- **24G模式**: 2.4GHz无线通信应用
- **LL_SYNC模式**: 低功耗蓝牙同步应用
- **TUYA模式**: 涂鸦智能应用
- **CENTRAL模式**: 蓝牙中央设备应用
- **BEACON模式**: 蓝牙信标应用
- **IDLE模式**: 空闲应用

## 任务调度流程

系统按以下任务列表进行调度：

- app_core: 核心应用任务
- sys_event: 系统事件任务
- btctrler: 蓝牙控制器任务
- btencry: 蓝牙加密任务
- btstack: 蓝牙协议栈任务
- systimer: 系统定时器任务
- update: 更新任务
- dw_update: 下载更新任务
- 音频解码/编码任务
- LED控制任务

## 10ms循环处理流程

main_while()函数每10ms被调用一次，执行以下操作：

1. RF24G按键处理
2. 功率上电效果
3. 特殊关闭效果
4. 呼吸灯效果
5. 渐变效果
6. 串口按键处理
7. RF24G长定时器处理
8. 声音处理
9. Tick定时处理
10. WS2812灯带服务

## 定时器处理流程

- user_timer_init(): 初始化用户定时器，设置为50μs中断
- user_timer_isr(): 定时器中断服务函数，处理RF433定时器钩子函数

## 程统休眠判断流程

- eSystemConfirmStopStatus(): 判断系统是否可以进入无限睡眠状态
  - 返回1表示允许无限睡眠
  - 返回0表示每100ms唤醒一次
